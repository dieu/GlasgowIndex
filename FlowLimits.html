<!DOCTYPE html>
<html lang="en-GB">
<head>
<title>Glasgow Index</title>
<link rel="shortcut icon" href="favicon.ico" type="image/x-icon" />
<link rel="icon" href="favicon.ico" type="image/x-icon" />

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns/dist/chartjs-adapter-date-fns.bundle.min.js"></script>
<script src="EDFFile.js"></script>
<script src="FlowLimits.js"></script>

</head>
<body style="font-family: sans-serif">
	<div>
		<span style="font-weight:700;font-size:24px;">Glasgow Index (v0.1 Beta)</span>
		<span style="padding-left:100px;">For Sleep Disordered Breathing / Flow Limitations</span>
		<span style="padding-left:100px;">(See <a href="Intro.html">introduction</a>)</span>
	</div>
        <p>Select folder or files containing Resmed "*DATE*_*TIME*_BRP.edf": <input type="file" name="inputfile" id="fileInput" multiple webkitdirectory directory style="padding-left:40px;"></p>
        <p>Sessions:<select id="sessionSelect" style="margin-left:40px;"></select></p>
	<div>
  		<canvas id="chartTop"></canvas>
	</div>
	<div>
		<canvas id="chartDetail" style="height: 300px;"></canvas>
	</div>
	<div style="margin:auto;width:250px;">
		<button id="backBtn" style="visibility: hidden;">&lt;&lt;Back</button>
		<button id="fwdBtn" style="visibility: hidden;">Fwd&gt;&gt;</button>
		<p>This is not a medical product</p>
	</div>
	
<script type="text/javascript">

let chartTop = null;
let chartDetail = null;

let detailSampleSelected = 0;

const sessions = [];
let activeSessionIndex = -1;
const sessionSelect = document.getElementById('sessionSelect');
sessionSelect.disabled = true;

document.getElementById('backBtn').addEventListener('click', function () {
        const session = getActiveSession();
        if (!session){
                return;
        }
        showDetailBack(session.dataArray, session.results);
});
document.getElementById('fwdBtn').addEventListener('click', function () {
        const session = getActiveSession();
        if (!session){
                return;
        }
        showDetailForward(session.dataArray, session.results);
});

sessionSelect.addEventListener('change', function (event) {
        const index = parseInt(event.target.value, 10);
        if (Number.isNaN(index)){
                return;
        }
        setActiveSession(index);
});

document.getElementById('fileInput').addEventListener('change', async function (event) {
        resetSessions();
        await queueEDFFileProcessing(event.target.files);
        if (sessions.length > 0){
                setActiveSession(0);
        }
    }
);

function acceptFile(arrayBuffer){
        // read in file using EDF ("European Data Format" for sleep data) parser
        let fileData = parseEDFFile(arrayBuffer);
        if (fileData.formatVersion!=="0"){
                alert("File specified in incorrect format");
                return null;
        }

        const session = {
                startDateTime: new Date(fileData.startDateTime.getTime()),
                dataArray: formDataArray(fileData),
                results: {}
        };
        const { dataArray, results } = session;

        // find peak flow rate expirations (maximum negative flow)
        findMins(dataArray);
        // find and examine inspirations
        findInspirations(dataArray, results);
        // compare the relationship between expirations and inspiration
        calcCycleBasedIndicators(dataArray, results);
        // prepare an idealised flow for display (not used in calcs)
        prepIdealFlow(dataArray, results);
        // determine variance of amplitude (inspiration max flow)
        inspirationAmplitude(dataArray, results);
        // prepare the indices
        results.cumIndex = prepIndices(results);
        // compare inspiration & expiration volume looking for where they are not balanced
        flowBalance(dataArray, results);

        return session;
}

function handleSessionCreated(session){
        const sessionIndex = sessions.length;
        sessions.push(session);

        const option = document.createElement('option');
        option.value = String(sessionIndex);
        option.text = session.startDateTime.toLocaleString();
        sessionSelect.appendChild(option);
        sessionSelect.disabled = false;
}

function setActiveSession(index){
        if (index < 0 || index >= sessions.length){
                return;
        }
        activeSessionIndex = index;
        sessionSelect.value = String(index);
        detailSampleSelected = 0;
        clearDetailGraph();
        displayHeatMap(sessions[index]);
}

function getActiveSession(){
        if (activeSessionIndex < 0 || activeSessionIndex >= sessions.length){
                return null;
        }
        return sessions[activeSessionIndex];
}

function resetSessions(){
        sessions.length = 0;
        activeSessionIndex = -1;
        detailSampleSelected = 0;
        sessionSelect.innerHTML = "";
        sessionSelect.disabled = true;
        sessionSelect.value = "";
        clearDetailGraph();
        const topCanvas = document.getElementById('chartTop');
        const ctx = topCanvas.getContext('2d');
        ctx.clearRect(0, 0, topCanvas.width, topCanvas.height);
}
</script>

</body>
</html>