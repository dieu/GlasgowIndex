<!DOCTYPE html>
<html lang="en-GB">
<head>
<title>Glasgow Index</title>
<link rel="shortcut icon" href="favicon.ico" type="image/x-icon" />
<link rel="icon" href="favicon.ico" type="image/x-icon" />

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns/dist/chartjs-adapter-date-fns.bundle.min.js"></script>
<script src="EDFFile.js"></script>
<script src="FlowLimits.js"></script>

<style>
        body {
                font-family: sans-serif;
        }

        #sessionControls {
                display: flex;
                align-items: center;
                flex-wrap: wrap;
                gap: 16px;
                margin-top: 8px;
                margin-bottom: 8px;
        }

        #sessionControls label {
                font-weight: 600;
        }

        #sessionControls select {
                min-width: 220px;
        }

        #sessionControls .compare-toggle {
                font-weight: normal;
                display: flex;
                align-items: center;
                gap: 8px;
        }

        #comparisonControls {
                display: flex;
                flex-direction: column;
                gap: 8px;
                margin-left: 40px;
                margin-bottom: 16px;
        }

        #compareOptions {
                display: flex;
                flex-wrap: wrap;
                gap: 12px;
        }

        #compareOptions label {
                display: flex;
                align-items: center;
                gap: 6px;
        }

        #singleOverviewWrapper,
        .overview-grid {
                margin-top: 16px;
        }

        .overview-grid {
                display: grid;
                gap: 16px;
                grid-template-columns: 1fr;
        }

        .overview-item {
                padding: 8px;
                border: 1px solid #d5d5d5;
                border-radius: 4px;
                background-color: #ffffff;
        }

        .overview-item.active-session {
                border-color: #1b1e7a;
                box-shadow: 0 0 0 2px rgba(27, 30, 122, 0.2);
        }

        .overview-canvas {
                width: 100%;
                height: 350px;
                display: block;
        }

        .detail-container {
                margin-top: 24px;
                height: 300px;
        }

        .detail-container canvas {
                height: 100%;
        }

        .hidden {
                display: none !important;
        }

        @media (min-width: 900px) {
                .overview-grid {
                        grid-template-columns: repeat(auto-fit, minmax(320px, 1fr));
                }
        }
</style>

</head>
<body style="font-family: sans-serif">
	<div>
		<span style="font-weight:700;font-size:24px;">Glasgow Index (v0.1 Beta)</span>
		<span style="padding-left:100px;">For Sleep Disordered Breathing / Flow Limitations</span>
		<span style="padding-left:100px;">(See <a href="Intro.html">introduction</a>)</span>
	</div>
        <p>Select folder or files containing Resmed "*DATE*_*TIME*_BRP.edf": <input type="file" name="inputfile" id="fileInput" multiple webkitdirectory directory style="padding-left:40px;"></p>
        <div id="sessionControls">
                <label for="sessionSelect">Sessions:</label>
                <select id="sessionSelect"></select>
                <label class="compare-toggle"><input type="checkbox" id="compareToggle" disabled>Compare sessions</label>
        </div>
        <div id="comparisonControls" class="hidden">
                <span>Select sessions to compare:</span>
                <div id="compareOptions"></div>
        </div>
        <div id="overviewSection">
                <div id="singleOverviewWrapper">
                        <canvas id="chartTop" class="overview-canvas"></canvas>
                </div>
                <div id="comparisonOverviewContainer" class="overview-grid hidden"></div>
        </div>
        <div id="detailContainer" class="detail-container hidden">
                <canvas id="chartDetail" height="300"></canvas>
        </div>
	<div style="margin:auto;width:250px;">
		<button id="backBtn" style="visibility: hidden;">&lt;&lt;Back</button>
		<button id="fwdBtn" style="visibility: hidden;">Fwd&gt;&gt;</button>
		<p>This is not a medical product</p>
	</div>
	
<script type="text/javascript">

const chartTopCanvas = document.getElementById('chartTop');
let chartDetail = null;

let detailSampleSelected = 0;

const sessions = [];
let activeSessionIndex = -1;
const sessionSelect = document.getElementById('sessionSelect');
sessionSelect.disabled = true;

const compareToggle = document.getElementById('compareToggle');
const comparisonControls = document.getElementById('comparisonControls');
const compareOptionsContainer = document.getElementById('compareOptions');
const comparisonOverviewContainer = document.getElementById('comparisonOverviewContainer');
const singleOverviewWrapper = document.getElementById('singleOverviewWrapper');
const detailContainer = document.getElementById('detailContainer');
const compareSelectedSessions = new Set();
let compareModeEnabled = false;

document.getElementById('backBtn').addEventListener('click', function () {
        const session = getActiveSession();
        if (!session){
                return;
        }
        showDetailBack(session.dataArray, session.results);
});
document.getElementById('fwdBtn').addEventListener('click', function () {
        const session = getActiveSession();
        if (!session){
                return;
        }
        showDetailForward(session.dataArray, session.results);
});

sessionSelect.addEventListener('change', function (event) {
        const index = parseInt(event.target.value, 10);
        if (Number.isNaN(index)){
                return;
        }
        setActiveSession(index);
});

compareToggle.addEventListener('change', function (event) {
        compareModeEnabled = event.target.checked;
        updateCompareModeUI();
});

document.getElementById('fileInput').addEventListener('change', async function (event) {
        resetSessions();
        await queueEDFFileProcessing(event.target.files);
        if (sessions.length > 0){
                setActiveSession(0);
        }
    }
);

function acceptFile(arrayBuffer){
        // read in file using EDF ("European Data Format" for sleep data) parser
        let fileData = parseEDFFile(arrayBuffer);
        if (fileData.formatVersion!=="0"){
                alert("File specified in incorrect format");
                return null;
        }

        const session = {
                startDateTime: new Date(fileData.startDateTime.getTime()),
                dataArray: formDataArray(fileData),
                results: {}
        };
        const { dataArray, results } = session;

        // find peak flow rate expirations (maximum negative flow)
        findMins(dataArray);
        // find and examine inspirations
        findInspirations(dataArray, results);
        // compare the relationship between expirations and inspiration
        calcCycleBasedIndicators(dataArray, results);
        // prepare an idealised flow for display (not used in calcs)
        prepIdealFlow(dataArray, results);
        // determine variance of amplitude (inspiration max flow)
        inspirationAmplitude(dataArray, results);
        // prepare the indices
        results.cumIndex = prepIndices(results);
        // compare inspiration & expiration volume looking for where they are not balanced
        flowBalance(dataArray, results);

        return session;
}

function handleSessionCreated(session){
        const sessionIndex = sessions.length;
        sessions.push(session);

        const option = document.createElement('option');
        option.value = String(sessionIndex);
        option.text = session.startDateTime.toLocaleString();
        sessionSelect.appendChild(option);
        sessionSelect.disabled = false;
        compareToggle.disabled = sessions.length < 2;

        addComparisonOption(sessionIndex, session);
        if (compareModeEnabled){
                refreshComparisonOverview();
        }
}

function setActiveSession(index){
        if (index < 0 || index >= sessions.length){
                return;
        }
        activeSessionIndex = index;
        sessionSelect.value = String(index);
        detailSampleSelected = 0;
        clearDetailGraph();
        displayHeatMap(sessions[index]);
        if (compareModeEnabled){
                ensureActiveSessionInComparison();
        }
        refreshComparisonOverview();
}

function getActiveSession(){
        if (activeSessionIndex < 0 || activeSessionIndex >= sessions.length){
                return null;
        }
        return sessions[activeSessionIndex];
}

function resetSessions(){
        sessions.length = 0;
        activeSessionIndex = -1;
        detailSampleSelected = 0;
        sessionSelect.innerHTML = "";
        sessionSelect.disabled = true;
        sessionSelect.value = "";
        compareSelectedSessions.clear();
        compareToggle.checked = false;
        compareToggle.disabled = true;
        compareModeEnabled = false;
        comparisonControls.classList.add('hidden');
        compareOptionsContainer.innerHTML = "";
        comparisonOverviewContainer.innerHTML = "";
        comparisonOverviewContainer.classList.add('hidden');
        singleOverviewWrapper.classList.remove('hidden');
        clearDetailGraph();
        chartTopCanvas.onclick = null;
        const ctx = chartTopCanvas.getContext('2d');
        ctx.clearRect(0, 0, chartTopCanvas.width, chartTopCanvas.height);
}

function addComparisonOption(sessionIndex, session){
        const label = document.createElement('label');
        label.className = 'compare-option';
        const checkbox = document.createElement('input');
        checkbox.type = 'checkbox';
        checkbox.value = String(sessionIndex);
        checkbox.addEventListener('change', function (event) {
                const idx = parseInt(event.target.value, 10);
                if (event.target.checked){
                        compareSelectedSessions.add(idx);
                }else{
                        compareSelectedSessions.delete(idx);
                }
                syncCompareSelectionUI();
                refreshComparisonOverview();
        });
        const textSpan = document.createElement('span');
        textSpan.textContent = session.startDateTime.toLocaleString();
        label.appendChild(checkbox);
        label.appendChild(textSpan);
        compareOptionsContainer.appendChild(label);
        syncCompareSelectionUI();
}

function syncCompareSelectionUI(){
        const checkboxes = compareOptionsContainer.querySelectorAll('input[type="checkbox"]');
        checkboxes.forEach((checkbox) => {
                const idx = parseInt(checkbox.value, 10);
                checkbox.checked = compareSelectedSessions.has(idx);
        });
}

function ensureActiveSessionInComparison(){
        if (!compareModeEnabled || activeSessionIndex < 0){
                return;
        }
        if (!compareSelectedSessions.has(activeSessionIndex)){
                compareSelectedSessions.add(activeSessionIndex);
                syncCompareSelectionUI();
        }
}

function refreshComparisonOverview(){
        comparisonOverviewContainer.innerHTML = '';
        if (!compareModeEnabled){
                comparisonOverviewContainer.classList.add('hidden');
                return;
        }
        syncCompareSelectionUI();
        const selectedIndices = Array.from(compareSelectedSessions).filter((idx) => idx >= 0 && idx < sessions.length);
        if (selectedIndices.length === 0){
                comparisonOverviewContainer.classList.add('hidden');
                return;
        }
        selectedIndices.sort((a, b) => a - b);
        comparisonOverviewContainer.classList.remove('hidden');
        selectedIndices.forEach((idx) => {
                const wrapper = document.createElement('div');
                wrapper.className = 'overview-item';
                if (idx === activeSessionIndex){
                        wrapper.classList.add('active-session');
                }
                const canvas = document.createElement('canvas');
                canvas.className = 'overview-canvas';
                wrapper.appendChild(canvas);
                comparisonOverviewContainer.appendChild(wrapper);
                renderSessionOverview(canvas, sessions[idx], {
                        onSelect: () => {
                                if (idx !== activeSessionIndex){
                                        setActiveSession(idx);
                                }
                        },
                });
        });
}

function updateCompareModeUI(){
        if (compareModeEnabled){
                comparisonControls.classList.remove('hidden');
                singleOverviewWrapper.classList.add('hidden');
                ensureActiveSessionInComparison();
                refreshComparisonOverview();
                clearDetailGraph();
        }else{
                comparisonControls.classList.add('hidden');
                comparisonOverviewContainer.innerHTML = '';
                comparisonOverviewContainer.classList.add('hidden');
                singleOverviewWrapper.classList.remove('hidden');
        }
}
</script>

</body>
</html>